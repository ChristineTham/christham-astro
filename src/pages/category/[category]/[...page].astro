---
import type { MarkdownInstance, PaginateFunction, Page } from 'astro'
import type { Frontmatter } from '../../../config'
import { SiteMetadata, categoryDetail, PAGE_SIZE } from '../../../config'
import Base from '../../../layouts/base.astro'
import PageHero from '../../../components/pagehero.astro'
import BlogRoll from '../../../components/blogroll.astro'
import SVGImg from '../../../components/svgimg.astro'
import PaginateControl from '../../../components/paginatecontrol.astro'

export interface Props {
  page: Page<MarkdownInstance<Frontmatter>>
}

const { category } = Astro.params
const { page } = Astro.props

const detail = categoryDetail(category as string)

const frontmatter: Frontmatter = {
  title: 'Category: ' + category + (page.size < page.total ? ' (page ' + page.currentPage + ' of ' + page.lastPage + ')' : ''),
  description: detail.description,
  coverSVG: detail.coverSVG,
  socialImage: detail.socialImage,
  publishDate: SiteMetadata.buildTime,
}

const currentPage = Astro.url.toString().replace(/\/\d+\/?$/, '')

export async function getStaticPaths({ paginate }: { paginate: PaginateFunction }) {
  const allPosts = (await Astro.glob(
    '../../blog/*.{md,mdx}'
  )) as MarkdownInstance<Frontmatter>[]
  const posts = allPosts
    .map(post => ({ file: post.file, url: post.url, frontmatter: post.frontmatter }))
    .sort(
      (a, b) =>
        new Date(b.frontmatter.publishDate).valueOf() -
        new Date(a.frontmatter.publishDate).valueOf()
    )
    .filter(post => !post.frontmatter.draft)

  const categories = Array.from(new Set(posts.flatMap(post => post.frontmatter.categories)))

  return categories.map(category => {
    return paginate(posts.filter(post => category && post.frontmatter.categories?.includes(category)), {
      params: { category },
      pageSize: PAGE_SIZE
    })
  })
}
---

<Base frontmatter={frontmatter}>
  <header>
    <PageHero
      title={frontmatter.title}
      description={frontmatter.description}
      coverSVG={frontmatter.coverSVG}
      socialImage={frontmatter.socialImage}
    >
    <SVGImg slot="before" src={detail.icon} alt={category as string} class="h-32 w-32" />
    <PaginateControl base={currentPage} page={page} />
  </PageHero>
  </header>
  <main>
    <section class="px-4 py-8 max-w-screen-lg mx-auto prose prose-purple lg:prose-xl dark:prose-invert" >
      {detail.content}
    </section>
    <BlogRoll posts={page.data} />
  </main>
</Base>
